# Gestión de Nombres Únicos en Oracle: Una Solución Genérica

Recientemente me enfrenté al desafío de crear nombres de usuarios únicos de forma automática. Me propuse resolver el caso específico de generar un username único concatenando el primer nombre y apellido (first and last name), pero con la flexibilidad de que la solución fuera reutilizable para otros tipos de entidades.


**Ejemplo del problema:**
- Usuario 1: `john.doe`
- Usuario 2: `john.doe` → ¿Qué hacer?

## La Solución:

Se desarrolló una solución genérica que no solo resuelve el problema de usernames únicos, sino que puede aplicarse a cualquier entidad que requiera nombres únicos (proyectos, tenants, etc.).

Los recursos de esta solución los podemos encontrar en:

- `core_users.sql`
- `core_users_bi_trg.sql`
- `core_unique_names.sql`
- `core_unique_name_manager.pks`
- `core_unique_name_manager.pkb`

### Componentes Principales

#### 1. Tabla Genérica: `core_unique_names`

```sql
create table core_unique_names (
    name_id                      number generated by default on null as identity (start with 1) primary key not null
  , entity_type                  varchar2(50 char)              not null
  , base_name                    varchar2(100 char)             not null
  , counter                      number             default 0   not null
  , last_used                    timestamp with local time zone default localtimestamp not null
  , active_yn                    varchar2(1 char)   default 'Y' not null
  , created_by                   varchar2(60 char)  default
                                  coalesce(
                                    sys_context('APEX$SESSION','app_user')
                                  , regexp_substr(sys_context('userenv','client_identifier'),'^[^:]*')
                                  , sys_context('userenv','session_user')
                                  )
                                  not null
  , created_on                   timestamp with local time zone default localtimestamp not null
  , last_updated_by              varchar2(60 char)
  , last_updated_on              timestamp with local time zone
  , constraint uk_core_unique_names_entity_base unique (entity_type, base_name)
  , constraint chk_core_unique_names_active_yn check (active_yn in ('Y', 'N'))
);
```

#### 2. Package Genérico: `core_unique_name_manager`

```sql
create or replace package core_unique_name_manager as
    -- Función genérica para cualquier tipo de entidad
    function generate_unique_name(
        p_entity_type                    in varchar2
      , p_base_name                      in varchar2
    ) return varchar2;

    -- Wrapper específico para usernames
    function generate_unique_username(
        p_first_name                     in varchar2
      , p_last_name                      in varchar2
    ) return varchar2;
end;
/
```

### Cómo Funciona

#### Paso 1: Generación del Nombre Base
Para usernames, convertimos el nombre completo a un formato estándar:
- `Juan Carlos Pérez` → `juan_carlos.perez`
- `María José García-López` → `maria_jose.garcia-lopez`

#### Paso 2: Verificación de Unicidad
El sistema busca en la tabla `core_unique_names` si ya existe un registro para ese nombre base.

#### Paso 3: Generación del Nombre Único
- **Primera vez**: `juan_carlos.perez`
- **Segunda vez**: `juan_carlos.perez_1`
- **Tercera vez**: `juan_carlos.perez_2`

### Implementación Automática

#### Trigger en la Tabla de Usuarios

```sql
create or replace trigger core_users_bi_trg
before insert
on core_users
referencing old as old new as new
for each row
begin
    -- Generar username único automáticamente
    :new.username := core_unique_name_manager.generate_unique_username(
        :new.first_name
      , :new.last_name
    );
end;
/
```

### Ejemplos de Uso

#### 1. Creación Automática de Usuario
```sql
-- El trigger se ejecuta automáticamente
insert into core_users (
    first_name
  , last_name
  , email
) values (
    'Juan'
  , 'Pérez'
  , 'juan@email.com'
);
-- Resultado: username = 'juan.perez'

insert into core_users (
    first_name
  , last_name
  , email
) values (
    'Juan'
  , 'Pérez'
  , 'juan2@email.com'
);
-- Resultado: username = 'juan.perez_1'
```

### Ventajas de esta Solución

1. **Genérica**: No solo para usernames, sino para cualquier entidad
2. **Automática**: No requiere intervención manual
3. **Consistente**: Mismo formato para todos los usuarios
4. **Escalable**: Maneja miles de usuarios sin problemas
5. **Auditable**: Mantiene historial de nombres utilizados

### Aplicación a Otros Tipos de Entidades

Esta solución puede extenderse fácilmente a otros tipos de entidades:

```sql
-- Para proyectos
project_name := core_unique_name_manager.generate_unique_name(
    'PROJECT'
  , 'Mi Proyecto'
);
-- Resultado: 'mi_proyecto', 'mi_proyecto_1', etc.

-- Para tenants
tenant_name := core_unique_name_manager.generate_unique_name(
    'TENANT'
  , 'Empresa ABC'
);
-- Resultado: 'empresa_abc', 'empresa_abc_1', etc.
```

### Consideraciones de Rendimiento

- **Índices**: La tabla `core_unique_names` tiene índices en `(entity_type, base_name)`
- **Bloqueos**: El package usa `FOR UPDATE` para evitar condiciones de carrera
- **Transacciones**: Cada inserción es atómica

### Mantenimiento

#### Limpieza de Registros Inactivos
```sql
-- Marcar registros como inactivos en lugar de eliminarlos
update core_unique_names 
   set active_yn = 'N' 
 where last_used < sysdate - 365; -- Más de 1 año sin uso
```

## Conclusión

Esta solución genérica proporciona una base sólida para manejar nombres únicos en cualquier sistema Oracle. Su flexibilidad permite aplicarla a múltiples tipos de entidades, mientras que su automatización reduce la carga de trabajo del desarrollador y mejora la experiencia del usuario.

La clave está en la tabla `core_unique_names` que actúa como un registro central de todos los nombres utilizados, permitiendo un control granular y una generación predecible de alternativas únicas.
